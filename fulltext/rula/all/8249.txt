Wavelength Optimization in the Multispectral Photoacoustic Tomography of the Lymphatic Drainage in Mice
by

IHAB ABI NASSIF Bachelor of Physics Lebanese University, Lebanon,1998

A thesis presented to Ryerson University in partial fulfillment of the requirements for the degree of Master of Science in the program of Biomedical Physics

Ryerson University, August 2018

Toronto, Ontario, Canada, 2018 © IHAB ABI NASSIF 2018

Declaration

I hereby declare that I am the sole author of this thesis. This is a true copy of the thesis, including any required final revisions, as accepted by my examiners. I authorize Ryerson University to lend this thesis to other institutions or individuals for the purpose of scholarly research. I further authorize Ryerson University to reproduce this thesis by photocopying or by other means, in total or in part, at the request of other institutions or individuals for the purpose of scholarly research. I understand that my thesis may be made electronically available to the public.

Ihab Abi Nassif

ii

Wavelength Optimization in the Multispectral Photoacoustic Tomography of the Lymphatic Drainage in Mice
Master of Science 2018 IHAB ABI NASSIF Biomedical Physics Ryerson University

Abstract
Multispectral photoacoustic tomography provides a mapping of the tissue chromophore distribution by using a broad range of tunable laser wavelengths. While a large number of employed wavelengths may improve the separation of exogenous and endogenous chromophores, it also decreases the temporal resolution and increases the total energy deposition, which can cause bleaching of fluorescent dyes. With the overall goal of studying the dynamics of cerebrospinal fluid in mice in vivo, the work in this thesis aims to minimize the number of wavelengths in order to reduce the scanning time, improve the temporal resolution, reduce the energy deposition into the tissue and avoid photobleaching of the tracers while maintaining high image quality. Two methods were used to select small sets of wavelengths: the first method of wavelength selection was based on the minimization of the condition number of the extinction matrix, and the second method was based on the peak signal-to-noise ratio optimization of the chromophore images. 3 wavelengths set was selected based on minimum condition number proved to be enough to maintain good image quality and accurate mapping for chromophores and tracer.

iii

Acknowledgements
I would like to express my sincere gratitude towards my supervisor Dr. Vladislav Toronov for continuous support throughout my graduate study and research. I'd like to thank as well Dr. Yeni Yucel for his invaluable advice, countless constructive ideas and feedback throughout my research. I'd like to thank Dr. James Grafe for being a supportive member of my committee . I'd like to thank my colleague Xun Zhou for his great contribution. I'd like to thank Dr. Carl Kumaradas who offered me the opportunity to pursue my M.Sc degree at Ryerson University. Finally, I want to thank my dearest parents, my great wife, Samar, and lovely kids, Ralph, Ryan, Yasmina and Cibelle for all the support, care and love they offered, without which I couldn't achieve.

iv

Dedication
This thesis work is dedicated to my wife, Samar, who has been a great source of support and encouragement during the challenges of graduate school and life...

v

Table of Content
Abstract......................................................................................................................................................iii Acknowledgements......................................................................................................iv Dedication..................................................................................................................................................v List of tables:.............................................................................................................vii List of figures.............................................................................................................vii CHAPTER 1............................................................................................................1 Introduction..............................................................................................................1 1.1 The lymphatic drainage problem..........................................................................1 1.2 Multispectral Optoacoustic Tomography (MSOT)....................................................2 1.3 Previous works on wavelength optimization in MPAT ...............................................5 1.4 MSOT system.................................................................................................6 1.4.1 Laser Source.............................................................................................6 1.4.2 Ultrasound Transducers................................................................................7 1.5 Data formats in medical imaging.......................................................................... 7 1.6 viewMSOT Algorithm.......................................................................................7 1.7 Image quality quantitative assessment .....................................................................8 1.7.1 Mean Squared Error (MSE)............................................................................8 1.7.2 Peak Signal-to-Noise Ratio (PSNR)...................................................................9 1.7.3 Structure Similarity Metric (SSIM)....................................................................9 CHAPTER 2.............................................................................................................10 Journal manuscripts: Wavelength Optimization in the Multispectral Photoacoustic Tomography of the
Lymphatic Drainage in Mice....................................................................................................10

2.1 ABSTRACT........................................................................................................11 2.2 Introduction........................................................................................................11 2.3 Materials and Methods...........................................................................................12 2.3.1 The animal model and protocol..............................................................................12 2.3.2 MPAT imaging................................................................................................13 2.3.3 Chromophore spectra..........................................................................................13 2.3.4 Spectral deconvolution and image rendering ..............................................................14 2.3.5 Wavelength optimization and quality assessment ..........................................................15 2.4 RESULTS...........................................................................................................15 2.5 Discussion...........................................................................................................19 2.6 Conclusions.........................................................................................................20 CHAPTER 3............................................................................................................. 25 Discussion, Conclusions and Future work.....................................................,.......................25 3.1 DISCUSSION............................................................................................................................. 25 3.2 LIMITATIONS...................................................................................................26 3.3 CONCLUSIONS...................................................................................................26 3.4 FUTURE WORK...................................................................................................27 3.5 Appendices.........................................................................................................28 References...............................................................................................................29

vi

List of tables:
TABLE 2-1:Wavelngths sets compared in our study ....................................................... 16 TABLE 2-2: PSNR and SSIM values for the comparison of unsigned 8-bit and double images for all the wavelength sets in table 2-1 ................................................................................................17

List of figures:
FIGURE 1-1: Images reconstructed and compared using different algorithms available in viewMSOT..............................................................................................................08 FIGURE 2-1: Hb,HbO2 and QC-1 tracer spectra................................................................14 FIGURE 2-2: Image of the coronal sections of the mouse neck two hours after the tracer (QC1/BSA) injection into the subconjunctiva of right eye....................................................................14 FIGURE 2-3: Averaged PSNR values for all sets unsigned 8-bit and double images.........................17 FIGURE 2-4: 8-bit chromophore maps obtained using different wavelength sets with ViewMSOT software ......18

vii

Chapter 1
Introduction
1.1 The lymphatic drainage problem A published estimation in 2014 shows that ~79 million people will have glaucoma worldwide in 2020, out of which ~58million will suffer from Primary Open-Angle Glaucoma and ~21million will suffer Primary Angle-Closure Glaucoma [1]. Being the leading cause optic nerve damage and field of vision is loss, glaucoma is considered the leading cause of irreversible blindness and there is a great need for improvements in the tools of glaucoma identification and treatment. [1]. Glaucoma is usually associated with high intraocular pressure (IOP) and defect in the drainage of aqueous humor [2]. Increasing aqueous humor drainage from the eye is one of the main aims of glaucoma treatment. Two aqueous outflow pathways were known for their contribution to aqueous drainage, the conventional and unconventional pathway [2]. Another alternate pathway called the uveolymphatic has been proposed based on the ciliary body lymphatics found and intracamerally injected tracer detected in ciliary body lymphatic channels and cervical lymph nodes [2]. The lymphatic system of humans and mammals, which is composed of lymphatic vessels and lymph nodes, is essential for fluid homeostasis and immune competences [2].Lymph fluid is composed of water, white blood cells and plasma proteins , thus water is the main optical absorber while in blood, light is absorbed mainly by oxy- and deoxyhemoglobin [2]. A discovery of the lymphatic vessels in the ciliary body of the human eye opened the door for further investigations of ocular lymphatic drainage [2]. the mouse appears to be an adequate study model due to the similarity to human aqueous dynamics and pharmacology [2] 1.2 Multispectral Optoacoustic Tomography Photoacoustic effect is the process in which absorption of electromagnetic EM energy by a tissue creates localized thermal excitation then a thermo-elastic expansion takes place and outgoing acoustic waves are produced [3]. Although nonionizing wave causes no harm, still it scatters in soft tissue and that leads to significant drop in spatial resolution with depth. On the other hand, ultrasound scattering is weaker than optical scattering by two to three times which is the reason behind the better resolution an ultrasound can provide in depths more than 1mm. However, in pure ultrasound imaging, the mechanical properties of the tissues are detected, and the contrast is

1

weak to the point that early stage tumors are not revealed, while optical absorption is very sensitive to oxygen saturation and hemoglobin concentration [4]. Photoacoustic imaging (PA) is a non-invasive imaging modality which has come a long way in the last fifteen years, it is based on photoacoustic effect and can be considered either an EM imaging modality with ultrasoundenhanced resolution or an ultrasound modality with EM-enhanced contrast [3]. A thermally induced pressure variation occurs when the molecules of a tissue absorbs light and thus ultrasonic waves are created and then received, with various time delays, by a grid of transducers to determine the initial acoustic distribution of the source, and to map the EM energy deposition functions or absorption properties to finally form a PA image [4]. Multispectral optoacoustic tomography (MSOT) is used to resolve intrinsic chromophores (oxygenated and deoxygenated Hemoglobin) and extrinsic dyes and tracers with molecular specificity through several millimetres to centimeters of tissue. Photoacoustic effect is the base of this technique where the thermos-elastic expansion takes place after absorption of ultra-short laser pulses at different wavelengths [5]. MPAT facilitates functional, molecular, anatomical and oxygen metabolism expression, it is a widely used tool in several applications among which are ophthalmology, cardiology, neurology and vascular biology [6]. Last couple of years various review articles on MPAT applications were published. Such as molecular imaging, multiscale functional imaging, whole body imaging of small animal, real time MPAT with imaging tracers and agents [5, 6, 7, 8]. MPAT offers improved resolution of tissue chromophores due to the combination of high resolution of ultrasound imaging with the high molecular specificity that comes from different light absorption at different near-infrared wavelengths [9]. Hemoglobin distribution and oxygen saturation which are the cancer indicators are mapped using multiple wavelengths optical absorption [9]. Based on MPAT, [10] introduced the development of a novel method associated with molecularly-activated plasmonic Nano-sensors (MAPS), where the underlying molecular expressions can be visualised with the help of contrast agents for in vivo applications. Using near-infrared contrast agents, MPAT is used to map the lymphatic drainage and spread of tumors to sentinel nodes [2]. To trace the lymphatic drainage from the eye anterior chamber into the neck lymph nodes of the mouse we used the near-infrared dye QC-1 (LI-COR Biosciences, NE, USA). The ultimate goal of the study was to ensure the accurate separation from the endogenous chromophores (such as oxy- and deoxyhemoglobin) and mapping of the NIR tracer using a minimum number of light wavelengths. In addition to our ultimate goal, using a minimum

2

number of wavelengths decreases the acquisition time and thus increases the number of scans per given period. In addition, reducing the number of wavelengths in image acquisition reduces the motion artifacts from the processed images and decreases the amount of energy absorbed by the tissue. Another benefit of the number of wavelengths reduction is reducing the photobleaching effect which is the irreversible fading of fluorescence during measurements [11]. Finally, a reduced number of wavelengths improves the temporal resolution of images which is at its maximum for a single wavelength acquisition (MSOT inVision 128, iThera Medical GmbH) [12]. When the EM pulse is absorbed by the tissue, the change in temperature in the tissue is given by equation (1) introduced in [13]:  =  (1)




 is the mass density (kg.cm-3),  is the specific heat capacity at constant volume (J. kg-1. K-1), and  is the absorbed energy density (J.cm-3), given by equation (2):   =  () (2)

a is the absorption coefficient (cm-1) and F(r ): is the local optical fluence (J.cm-2) The change in temperature leads to a change in local pressure, this change in pressure is given by equation (3). )=  (
( ) 

(3)

P(r ) change in pressure (Pa), T(r ) change in temperature (K),  is the isothermal compressibility (Pa-1), and  is the thermal coefficient of volume expansion (K-1). In tissues,  is approximately 5.10-10 Pa-1 and  is around 4.10-4 K-1, Thus each mK temperature rise generates an 800 Pa pressure rise, which is a detectable ultrasound [12] The laser pulse length is short enough that the rise in local pressure and temperature is constrained to small volume. The combination of equations (1), (2) and (3) gives the equation of initial photoacoustic pressure signal:
  =  ()   () =   ()


(4),

The generated photoacoustic pressure Po will be detected by an array of ultrasound transducers after propagation through the sample and thus being attenuated. The photoacoustic image is formed through the time recovery of Po from the detected pressure Pd [14].  (  , ) =  [4   ()] (5) |  - |=  0
 





d is the solid-angle element of  with respect to the point at  and vs is the speed of sound.

3

An inversion solution of equation (5) leads to P0. Equation (6) represents the time domain expression of the universal back projection (UBP) algorithm 0 () =    [2 ( , ) - 2 
0

1

 ( ,) 

]|

=| - |/

(6)

0 (sr) is the solid angle of the whole detection surface S with respect to a given source point at  . In our work and to focus on spectral unmixing and simplify the problem, the pressure is assumed to be accurately reconstructed. The laser fluence at the absorber  varies according to the optical wavelength  and the optical properties of the tissue. In addition, the optical absorption coefficient of the absorber  is also a function of the optical wavelength  and each absorber contributes to the overall absorption. [14]. For  chromophores (absorbers): () = ()(1 () + 2 () + 3 () +  +  ()) (7) Equation (8) represents the relation between the optical absorption and the concentration of the absorber (Beer's Law)  =   () (8)  is the concentration of the   absorber (mol.cm-3), and  () is the molar absorption of the   absorber at wavelength  (cm-1.M-1). Equation (9) is the Combination of equations (7) and (8): () = () (1 1 () + 2 2 () + 3 3 () +  +   ()) (9) At constant temperature, the   parameter variation in water-based tissue is negligible, thus it's often assumed to be constant. Knowing the fluence at the absorber, the optical absorption coefficient vector,  (), can be estimated:  () = F() (10) the combination of (10) and (9) to (11)  () =  (11) 1 2 1 3  ) .  . . ( )
()

 (1 )  (2 ) 11  (3 ) =(  . 1 . . ( ( ))

  

(12)

4

The components of  () vector correspond to absorption coefficient reconstructed at each wavelength. In the  matrix, each row represents the set of molar absorption coefficients (or molar extinction coefficients) of an optical absorber at different wavelengths. In the  vector each element corresponds to the relative concentration of each optical absorber [14]. Equation (12) can be solved for  under a condition that the number of optical wavelengths used to acquire images () is greater or equal to the number of absorbers (). In the presence of noise, it is useful to have  >  and in case the number of equations will be greater than the number of unknowns leading to an over-constrained system. A least squared error estimate of  is found by multiplying the two sides of equation (12) by the Moore-Penrose pseudoinverse of , + , where + = ( )-  and this leads to   +      -   -             -  Minimizing the condition number ( = 1   -   

 

) maintains stability under pseudoinverse

operation and preserve the spectral features of the absorption spectra. Spectral unmixing was performed using the ViewMSOTTM software (iThera Medical GmbH) and custom MATLAB® (MathWorks, Inc.) method accounting for the coloring of the excitation light due to surrounding water and tissue [15]. Linear Regression algorithm, one of the four algorithms offered by viewMSOTTM software (iThera Medical GmbH) was used. The chromophores included in our spectral model were oxy-, deoxy-hemoglobin and the IRDye QC-1 (LI-COR, Inc.) and using MATLAB® (MathWorks, Inc.), chromophore crosstalk filters were applied to remove oxy-, deoxy-hemoglobin signals from the tracer image. One of the wavelengths selection methods used in our work was based on [14] which introduced the procedure to select a minimum number of wavelengths by determining the submatrix of the molar absorption coefficient matrix based on the minimum condition number. The second method was based on peak signal-to-noise ratio (PSNR) optimization of the chromophores and tracer reconstructed maps 1.3 Previous works on wavelength optimization in MPAT In [16] Yuan, Z., & Jiang, H described a spectral approach in which absorbed energy density was recovered at each wavelength separately and then chromophore's (Hb, HbO2) concentration was obtained through combination of energy density across all wavelengths. Based on the algorithm and using 3 sets of 4-wavelengths each and 1 set of 6 wavelengths, physiological and acoustic 5

parameters were recovered simultaneously to improve the quality of the image by minimizing cross talk [16]. [17] determined the error of the blood oxygen saturation due to optical fluence approximation within blood vessels using two wavelengths 658 ± 40 nm and 1069 ± 40 nm. Acoustic pressure noise and error in determined optical scattering and absorption coefficients were taken into account [16]. [14] explained three methods for reduced wavelengths sets selection. The evenly separated selection, selection based on singular value (  ) algorithm, and selection based on condition number (  =
 

) algorithm [14]. Among the three

methods explained, the 3 wavelengths set selected based on maximum singular value (  ) as well as that based on minimum condition number showed better results than the set of evenly separated wavelengths [14] 1.4 MSOT system Throughout our research, our image acquisitions were performed using the MSOT inVision 128, iThera Medical GmbH. According to [12], the system identifies and quantifies disease-related biomarkers, revealing endogenous absorbers and injected probes and acquires whole-body in vivo images of small animals, with in-plane resolution of 150 m in real time. MSOT inVision 128, iThera Medical GmbH covers a broad range of applications including cancer, cardiovascular, neuro and pharmacokinetic imaging [12]. For cancer, it helps in understanding tumors through measuring probe accumulation, analyzing distribution, determining oxygenation status, and visualizing and quantifying (micro-vasculature [12]. On the cardio level, it monitors blood flow through the visualization of blood vessels in all body regions, quantifying blood oxygenation in vessels and tissue, and analyzing atherosclerotic plaque deposition. [12]. On the neuro level, it offers high resolution imaging of deep brain structures through intact skin and skull, it determines probe distribution in the brain and characterizes blood brain barrier integrity [12]. In terms of Kinetics, it follows probe uptake and elimination in real time, analyzes hepatic and renal function and it facilitates kinetic profiling of multiple probes simultaneously [12]. 1.4.1 Laser Source According to [12], iThera Medical GmbH, MSOT uses a pulsed Optical Parametric Oscillator (OPO). Nd:YAG is a solid state laser while OPO is used to tune the wavelength in singlenanometer steps[12]. The light from the fiber covers an area of approximately 4cm2 and generates a surface fluence of close to 20mJ/cm2, thereby within the ANSI limits of safe exposures for humans.

6

1.4.2 Ultrasound Transducers As mentioned in [12], the ultrasound arrays are number of detector elements that collect broadband signals and have a central frequency of 5MHz. The allowed practical acquisition of signals is between 50kHz and 7MHz with an in-plane spatial resolution of 150m at depth. MSOT inVision 128, iThera Medical GmbH offers a 270-degree angular detector coverage and cross-sectional imaging is possible throughout the animal regardless of positioning. 1.5 Data formats in medical imaging Through reconstruction, numerical values are mapped to certain spatial positions to form an image. In a given imaging modality, the field-of-view is described by pixels and it expresses how detailed the function or anatomy can be rendered. Metadata is the information beyond the pixel data that describe the image and it's stored as a header at the beginning of the file [18]. Typically, Metadata contains the image matrix dimension, pixel depth, spatial resolution and photometric interpretation [18]. Due to the nature of medical images, metadata have information about the image production process [18]. Three main image formats are usually used in medical imaging; intensity image, binary image and color image [19]. Throughout our image reconstruction and analysis, we used the intensity image, which is a data matrix of all values that are scaled to represent intensities where the values are in the range [0,255] in uint8 images, and [0,1] in the scaled class double intensity images where the values are floating-point numbers [19]. Another intensity image scale is the Uint16 where the values are in the range [0,65535] [19]. On the other hand, in binary image (black and white), each pixel has one of the two logical values 0 or 1 while in the color image there are three channels (RGB) and each pixel corresponds to three intensity values [19]

1.6 viewMSOT algorithms viewMSOT (version 3.8) offers 2 algorithms for image reconstruction, the Back-projection (BP) and the Model-Based (MB) [12]. The (BP) algorithm is used more for online live-preview quick reconstructions with less reconstruction time compared to (MB) which is the preferred algorithm for offline reconstruction and has another advantage of taking into consideration the tran sducer's geometry that provides images of higher accuracy than (BP) [12].For Multi Spectral Processing (MSP), viewMSOT offers 4 algorithms; Linear Regression, Guided Independent Component Analysis (ICA), Principle Component Analysis (PCA) and Difference [12]. We did the

7

comparison between the two reconstruction algorithms and the four MSP algorithms at the very beginning of our project and found that there is no significant difference in the quality of images reconstructed based on (BP) and (MB) [12]. In terms of (MSP), Linear Regression algorithm was way better than the rest and that is clearly shown in the set of images reconstructed based on different algorithms in Figure 1. 1.7 Image quality quantitative assessment In order to measure the quality of the reconstructed image, a reference image is needed. The quality of the image is then measured as the degree of similarity between a reconstructed image and the image chosen as a reference. The Peak signal-to-noise ratio (PSNR) and the structure similarity metric (SSIM) were introduced in [20] as quantitative measures that can automatically predict perceived image quality. Mean Squared Error (MSE) and (PSNR) are used as error sensitivity metrics while structural similarity metric (SSIM) measures the structural similarity of an image against a reference image [20].

Figure 1-1: (a) Image reconstructed using (BP) and MSP for Hb, HbO2 and QC-1 tracer was performed using Linear Regression. The green color represents the QC- tracer region, the blue color represents the Hb regions and the red color represents the HbO2 region. (b) Image reconstructed using (BP) and MSP for HbO2 was performed using Linear Regression. The red color represents the HbO2 regions. (c) Image reconstructed using (MB) and MSP for HbO2 was performed using Linear Regression. The red color represents the HbO2 regions. (d) Image reconstructed using (BP) and MSP for Hb, HbO2 and QC-1 tracer was performed using Guided ICA. The green color represents the QC- tracer region, the blue color represents the Hb regions and the red color represents the HbO2 region. (e) Image reconstructed using (BP) and MSP for HbO2 tracer was performed using Difference algorithm. The mapping is too bad to show any useful signal. (f) Image reconstructed using (BP) and MSP for HbO2 was performed using PCA-ICA the red color represents the HbO2 region.

1.7.1 Mean Squared Error (MSE) MSE is considered as a signal fidelity measure that provides the level of error/distortion between two images one of which is considered as the reference. If we have two image pixels values O

8

(the original/reference) and D (Distorted/ reconstructed). In order to be compared, the two images must be identical. The size of each image is assumed (m x n). [20]
-1 2  = × -1 =0 =0  (,  ) - (, ) 1

(13)

The lower the MSE the closer is the reconstructed image to the reference one. MSE will be zero upon comparing two identical images. 1.7.2 Peak Signal-to-Noise Ratio (PSNR) Defined as the maximum possible power of a signal divided by the power of distorting noise affecting the representation quality, PSNR is an approximation to human perception of reconstruction quality. [20]  = 1010 
2

(14)

where L is the dynamic range of allowable pixel intensities for a grey scale 8-bit image, L=281=255, while for double images, L=1.The higher PSNR, the closer is the reconstructed image to the reference. Typical values for the PSNR for acceptable 8-bits image quality is 30 and 50 dB (the higher the better) [21]. For 16-bit data typical values for the PSNR are between 60 and 80 dB[21]. 1.7.3 Structure Similarity Metric (SSIM) SSIM was introduced in [16] based on the concept that the image degradations are considered as perceived changes in structural information instead of perceived errors. Luminance, structure and contrast are the three components of SSIM. (, ) = [(, )] . [(, )] . [(, )] (15) Where  > 0,  > 0   > 0 are parameters used to adjust the relative importance of the three components.  ,  and  are set 1 for simplicity. In our case, the chromophore maps reconstructed using a reduced number of wavelengths were compared with the maps obtained using 121wavelengths. PSNR and SSIM values were determined using MATLAB® (MathWorks, Inc.) and ImageJ 1.46r (NIH, USA) for the comparison of the chromophore maps reconstructed using a reduced number of wavelengths and the maps obtained using 121wavelengths.

9

Chapter 2
Journal manuscript Wavelength Optimization in the Multispectral Photoacoustic Tomography of the Lymphatic Drainage in Mice
Ihab Abi Nassif, Xun Zhou, Yeni H. Yucel, Vladislav Toronov Author Affiliations Ihab Abi Nassif
Ryerson University,350 Victoria St, Toronto, ON M5B 2K3, Canada iabinassif@ryerson.ca

Xun Zhou
Keenan Research Centre for Biomedical Science of St. Michael's Hospital, 30 Bond St, Toronto, ON M5B 1W8, Canada. Ophthalmology & Vision Sciences, Laboratory of Medicine & Pathobiology, St. Michael's Hospital, University of Toronto, 30 Bond Street, Toronto, ON M5B 1W8, Canada. ZhouXu@smh.ca

Yeni H. Yucel
Ryerson University,350 Victoria St, Toronto, ON M5B 2K3, Canada. Keenan Research Centre for Biomedical Science of St. Michael's Hospital, 30 Bond St, Toronto, ON M5B 1W8, Canada. Ophthalmology & Vision Sciences, Laboratory of Medicine & Pathobiology, St. M ichael's Hospital, University of Toronto, 30 Bond Street, Toronto, ON M5B 1W8, Canada. The Institute for Biomedical Engineering, Science & Technology (iBEST) St. Michael's Hospital, Toronto, ON M5B 1W8, Canada. Yucely@smh.ca

Vladislav Toronov
Ryerson University,350 Victoria St, Toronto, ON M5B 2K3, Canada. The Institute for Biomedical Engineering, Science & Technology (iBEST) St. Michael's Hospital, Toronto, ON M5B 1W8, Canada. toronov@ryerson.ca

2.1 Abstract 10

Multispectral photoacoustic tomography provides mapping of the tissue chromophore distributions using sets of tunable laser wavelengths. With the overall goal of studying the dynamics of cerebrospinal fluid in mice in vivo, our work aims to minimize the number of wavelengths to reduce scanning time, improve the temporal resolution, reduce the energy deposition and avoid the tracer photobleaching while maintaining high image quality. To select small sets of wavelengths we directly searched for the combinations of wavelengths providing the best and worst image quality in comparison with a reference image obtained using 121 closely spaced wavelengths between 680 and 980 nm in terms of the peak signal-to-noise ratio (PSNR). We have shown that using the PSNR optimization method, additional improvements could be achieved over the wavelength set selected using the method of the minimization of the extinction matrix condition number. Keywords--lymphatic drainage; photoacoustic; multispectral; fluorescent dye

2.2 Introduction Multispectral photoacoustic tomography (MPAT) is a rapidly evolving imaging modality, which offers improved resolution of tissue chromophores due to the combination of high resolution of ultrasound imaging with the high molecular specificity resulting from differences in the light absorption by different molecules at different near-infrared wavelengths [6, 7]. Due to its ability to facilitate functional, molecular, anatomical and oxygen metabolism expression, MPAT is a widely used tool for many applications among which are the ophthalmology, cardiology, neurology, vascular biology, molecular imaging, multiscale functional imaging, whole-body imaging of small animals, real-time dynamic imaging using tracers [6, 7, 5,8], and in cancer studies [9, 10]. Lymphatic vascular system, which comprises a network of vessels extending to almost every part of the body, drains the fluid from the interstitial tissue to regional lymph nodes and then to blood system to maintain overall fluid balance. Lymphatic vessels transport this clear fluid against a pressure gradient between tissue and venous system with an active pumping system. The lymphatic system is also involved in the metastatic spread of cancers. The discovery of the lymphatic vessels in the human eye [22] opened the door to further investigations of ocular lymphatic drainage [2]. The mouse appears to be an adequate study model due to the similarity to human aqueous dynamics and pharmacology [2]. Using near-infrared contrast agents, MPAT can be used in vivo to map the active lymphatic drainage in mice [2]. In this study, to trace the lymphatic drainage from the eye subconjunctival region into the neck lymph nodes of the mouse, 11

we used the near-infrared dye QC-1. The ultimate goal of the study was to ensure the accurate separation from the endogenous chromophores (such as oxy- and deoxyhemoglobin) and mapping of the NIR tracer using a minimum number of light wavelengths. Minimization of the number of wavelengths was important for this goal because it increased the temporal resolution, reduced the motion artifacts and the tissue energy deposition and decreased the photobleaching effect i.e. the irreversible fading of the dye contrast during measurements [11]. In terms of the wavelengths optimization in MPAT, Yuan et al [16] proposed using the approach earlier developed for the diffuse optical tomography of tissue [23], which was based on the minimization of the condition number of the matrix of the extinction coefficients of tissue chromophores. Luke & Emelianov [14] further examined this method along with two other methods for reduced wavelengths sets selection: they compared the evenly separated wavelengths and the wavelength set selected based on the maximum singular value ( ) of the extinction matrix and the set selected based on minimum condition number ( =
 

) algorithm [14]. Among the three methods, the set of

three wavelengths selected based on the maximum singular value ( ) as well as the set based on the minimum condition number showed better results than the set of evenly separated wavelengths [14]. While the idea of using the minimum condition number approach was based on the general theory of the optimal least square fitting [23], in this study we directly found the reduced wavelength sets producing the best quality of chromophore images (oxy and deoxyhemoglobin and the tracer) in comparison with the images obtained using 121 wavelengths between 680nm and 980nm using the maximum peak signal-to-noise ratio criterion [20]. 2.3 Materials and Methods 2.3.1 The animal model and protocol The study was performed after the approval by the St. Michael's Hospital's Animal Care Committee. Images were acquired using a commercially available MPAT system (MSOT inVision 128, iThera Medical GmbH, Germany) equipped with the tunable 532nm Nd:YAG solid-state laser that pumped an optical parametric oscillator. One microliter of QC-1 (1mM, LI-COR Biosciences, USA) conjugated with Bovine Serum Albumin (Sigma-Aldrich, USA) was injected into subconjunctiva of the right eye of CD1 albino mice (Charles River Laboratories, Canada) (n=4). The animal preparation was performed as previously described [2]. The mouse (~30g body weight) was wrapped in the waterproof plastic wrapping and placed into the imaging chamber filled with the warmed (34°C) water. The image was acquired 2 hours after the tracer injection into the

12

subconjunctival space of the right eye. At that time the molar concentration of QC-1 compared to the blood chromophores was on the order of ~1/106.

2.3.2 MPAT imaging The ultrasonic signals were recorded by the array of ultrasound transducers placed around the tissue, and then used to determine the initial acoustic distribution of the source, and to map the light absorption properties at 121 wavelengths between 680nm and 980nm with the step of 2 nm. The set of wavelengths was chosen between 680nm and 920nm to avoid the effects of the water absorption. The acquisition time per each wavelength was 1sec per slice (position), the total acquisition time for a set of 121 wavelengths was 121sec per slice. The back projection image reconstructions for each wavelength were performed using the native ViewMSOT
TM

software

(iThera Medical GmbH, Germany). The further multispectral image deconvolution using the linear regression algorithm produced images of the distributions of three chromophores: oxyhemoglobin (HbO2), deoxyhemoglobin (Hb), and the tracer QC-1 2.3.3 Chromophore spectra Figure 2 shows the NIR spectra of oxy- and deoxyhemoglobins and of the lymphatic tracer QC1. The hemoglobin specific absorption (molar extinction) spectra were taken from [24]. A nearinfrared quencher dye IRDye QC-1 (LI-COR Biosciences, NE) was used to trace the lymphatic drainage. The specific absorption of the tracer QC-1 was taken from [24]. The maximum absorption of QC-1 is at 737nm which is very close to the local minima of deoxyhemoglobin (Hb) and low absorption region of oxyhemoglobin (HbO2) and that makes QC-1, oxyhemoglobin (HbO2) and deoxyhemoglobin (Hb) dominates the signal at different regions where no severe overlapping between the tracer and the blood carrying it. Still, due to the low concentration of QC-1 compared to the blood chromophores (~1/10 ), Hb and HbO2
6

chromophore crosstalk filters were applied to clean the QC-1 maps (For this experiment we used QC-1 conjugated with bovine serum albumin)

13

Figure 2-1: Absorption spectra of oxyhemoglobin (HbO2), deoxyhemoglobin (Hb) and of QC-1/BSA tracer. QC-1 had maximum absorption at 737nm, where Hb had minimum absorption, while 756nm corresponded to the local maximum of Hb absorption. 800nm corresponded to the isosbestic point where Hb and HbO2 had equal specific absorption.

2.3.4 Spectral deconvolution and image rendering Spectral deconvolution was performed using ViewMSOTTM software and custom MATLAB® (MathWorks, Inc., USA) code, both based on the linear regression [16]. The chromophores included in our spectral model were oxy-, deoxy-hemoglobin and the IRDye QC-1, which is sufficient for the albino mouse. Using a custom MATLAB® code, the images were thresholded and the Hb and HbO2 chromophore crosstalk filters were applied to remove oxy-, deoxyhemoglobin cross-talk signals from the tracer images.

Figure 2-2: (a) ViewMSOTTM image of the coronal sections of the mouse neck two hours after the tracer (QC1/BSA) injection into the subconjunctiva of right eye. R(right),L(left),S(superior) and I(inferior) obtained using 121 wavelengths between 680 nm and 920 nm. The bright green color shows the tracer in the right neck lymph node (shown by arrow). Red and blue colors show HbO2 and Hb in the neck arteries and veins, respectively. (b) A separate tracer map reconstructed using MATLAB® and the same set of 121 wavelengths as in (a). In (b) the signals corresponding to the locations of the blood vessels were removed.

Figure 3 explains the importance of the accurate mapping of both the tracer and hemoglobin. Fig. 3 (a) shows a typical chromophore map of the coronal sections of the mouse neck two hours after

14

the tracer (QC-1/BSA) injection into the subconjunctiva of right eye obtained using 121 wavelengths between 680 nm and 920 nm. The bright green color shows the tracer in the right neck lymph node (shown by the arrow). Red and blue colors show HbO2 and Hb in the neck arteries and veins, respectively. In actuality, due to the low concentration of the tracer and minor spectral cross-talk with the hemoglobin the tracer may spuriously appear not only in the lymphatic vessels but also in the blood vessels. Figure 3 (b) shows only the tracer distribution. Since the goal of our study was mapping the lymphatic vessels, the pixels corresponding to the blood vessels in Fig. 3(b) were identified using the HbO2 and Hb images, and their values were set to zero so that only the lymph node appears bright in Fig. 3(b).

2.3.5 Wavelength optimization and image quality assessment The peak signal-to-noise ratio (PSNR) and the structure similarity metric (SSIM) were introduced in [20] as the error sensitivity metrics and the structural similarity, respectively, of an image against a reference image. For two identical images PSNR tends to infinity and SSIM tends to 1 [20]. To find the initial three - wavelength PSNR-optimized sets we calculated PSNR for the images obtained using all possible combinations of three wavelengths out of 121, and the reference image was the one obtained using all 121 wavelengths. Using our custom MATLAB code this PSNR optimization took about 16 hours on a PC equipped with the Intel® CoreTM i7 processor and 16 GB RAM. We also found a three-wavelength set using the minimization of the condition number (CNM) of the chromophore extinction (molar absorption coefficient) matrix [16-14] using our custom MATLAB® code. This set was not the same as in [14] though, since in our case one chromophore was QC-1 while in [12] the dye was MMPSense 750 FAST, Perkin Elmer. We also used PSNR and SSIM to measure the quality of images reconstructed using additional sets of four, five, and six wavelengths obtained by combining various wavelengths obtained using the PSNR and CNM methods. Since the final image data format can affect both PSNR and CNM values, we analyzed these measures for the unsigned 8-bit integer (the coarsest) and double precision (most precise) images. The peak value for the 8-bit images was 255, and for the double precision images it was taken as a maximum pixel value of the image. 2.4 Results Table 1 showed all wavelength sets included in our study. MCN minimization for the threechromophore extinction matrix yielded a set of 3 wavelengths (Set 1). PSNR optimization was

15

first performed for each of five slices, and then averaging was applied to determine three sets of wavelengths corresponding to best PSNRs for QC-1, HbO2 and Hb (Sets 2, 3, 4). One can see that each chromophore had its own optimal wavelength set different from the others. In addition to the optimized three-wavelength sets 1-4 we also created four-, five-, and sixwavelength sets (sets 5-7), by partitioning all different wavelengths found using PSNR and MCN optimizations into four, five and six clusters, so that the wavelengths in each set corresponded to the cluster centroid locations [24]. In addition, we included the five-wavelength set recommended by iThera Medical GmbH (set 8).

Table 2-1. Wavelength sets compared in the study.

# 1 2 3 4 5 6 7 8 9 10

Method Minimum condition number (MCN) QC-1 PSNR optimization Hb PSNR optimization HbO2 PSNR optimization Combination of PSNR- optimized and MCN Combination of PSNR- optimized and MCN Combination of PSNR- optimized and MCN Recommended by iThera Close to minimum average PSNR Minimum average PSNR

Wavelengths, nm 680, 724, 930 691 ± 8, 731 ± 8, 913 ± 3 680 ± 1, 828 ± 7, 886 ± 3 728 ± 9, 842 ± 13, 905 ± 6 684,728, 852, 916 686, 730, 836, 896, 922 680, 700, 730, 840, 886, 930 700,730,760,800,850 724, 782, 882 726, 784, 884

Finally, the three-wavelength sets 9 and 10 were selected based on the minimum average PSNR for Hb, HbO2 and QC-1 maps. Set 10 corresponded to the absolute minimum of the modulus of the three-wavelength extinction matrix determinant. Note that the wavelengths in sets 9 and 10 were well separated similar to those in sets 1-4.Table 2 shows PSNR and SSIM values for each of the ten sets. The 8-bit QC-1 images for all sets except set 10 had infinite PSNR and SSIM equal to one. For this reason, the PSNR and SSIM values corresponding to 8-bit images were averaged only for Hb and HbO2, while the values corresponding to the double precision images were averaged for all three chromophores. Figure 3 shows PSNR values from Table 2 sorted from largest to smallest for both unsigned integer and double precision images. One can see that

16

in terms of relative PSNR results for both 8-bit and double precision images were similar within standard deviations.
Table 2-2: PSNR and SSIM values averaged for five slices and two (8-bit images) or three (double precision images) chromophores.

8-bit images (Hb and HbO2, no QC-1)

Double images (Hb,HbO2 and QC-1) Average PSNR (dB) Average SSIM

Set #
1 2 3 4 5 6 7 8 9 10

Average PSNR (dB)

Average SSIM

54.4 ± 3.8 56.3 ± 3.2 56.2 ± 2.7 54.1 ± 3.4 58.7 ± 3.3 57.7 ± 3.8 57.1 ± 3.4 55.8 ± 3.0 43.2 ± 14.6 31.4 ± 11.2

0.994±0.003 0.996±0.001 0.996±0.002 0.989±0.004 0.998±0.002 0.997±0.001 0.996±0.002 0.997 ± 0.003 0.976 ± 0.026 0.958±0.010

29.7 ± 5.4 30.8 ± 4.1 29.4 ± 3.4 27.6 ± 5.2 33.3 ± 4.0 33.3 ± 4.8 31.9 ± 4.2 29.7 ± 3.5 15.3± 15.2 1.0 ± 11.5

0.97 ± 0.02 0.97± 0.02 0.97 ± 0.02 0.96 ± 0.04 0.98 ± 0.02 0.98 ± 0.02 0.97 ± 0.02 0.97 ± 0.02 0.94 ± 0.05 0.89 ± 0.04

Figure 2-3. Averaged PSNR values for all sets: (a) unsigned 8-bit Hb and HbO2 images; (b) double precision Hb, HbO2 and QC-1 images. Error bars are the standard deviations.

17

PSNRs for all optimized three-wavelength sets were close within their standard deviations. This showed that MCN method provided a relatively good set of three wavelengths (set 1), although not the best of all (set 2 had a slightly higher PSNR). The highest PSNRS were found for sets 5 (four wavelengths) and 6 (five wavelengths), obtained by partitioning wavelengths initially found by the three-wavelength optimization methods. The best sets 5 and 6 provided PSNR values approximately 10% higher than set 1. The 6-wavelength set 7 showed lower PSNR than sets 5 and 6. The five-wavelength set 8 recommended by the scanner vendor produces images of the same quality as the three-wavelength optimized sets. The worst set 10 had PSNR close to 30 time smaller than set 1 for double precision images and about half of set 1 PSNR for the 8-bit images. The main distinctions between PSNR values for double precision and 8-bit images were larger values for 8-bit images and larger differences between different sets for the double precision images. To visually assess the results in terms of the image quality, the 8-bit chromophore maps obtained using various wavelength sets with ViewMSOT software were shown in Figure 4 along with the reference image, which was obtained using 121 wavelengths.

Figure 2-4: 8-bit chromophore maps obtained using different wavelength sets with ViewMSOT software. Red, blue, and green show oxyhemoglobin, deoxyhemoglobin, and QC-1, respectively. The arrow shows the tracer concentrated in the right neck lymph nodes of the mouse; L,R,S,I indicate left, right, superior, and inferior sides.

One can see that the "good" wavelength sets 1, 5, and 8 produced images structurally close to the reference one with main differences in the hemoglobin distribution rather than in the tracer locations. The image from the "best" set 5 shows slightly better similarity with the reference image in terms of the deoxyhemoglobin distribution than images from other sets. The image for the

18

"worst" set 10 shows no similarity with the reference, and the image for the "bad" set 9 shows some poor similarity in terms of the oxy-hemoglobin distribution and no similarity in terms of other chromophore distributions.

2.5 Discussion Unlike previous similar studies relying on the CNM method to minimize the number of wavelengths for MPAT [16-14], in this study we found the best wavelength sets for imaging specific chromophores by a direct search through all possible three-wavelength combinations to find the combinations providing the highest and the lowest PSNR values. Similar to the previous work [14] we used the images obtained using a large set of 121 closely spaced wavelengths as a reference image. We did not consider the aspect of wavelength optimization from the standpoint of the optimal optical fluence evaluation within the blood or lymphatic vessels [17], which will be addressed in our future work. Apart from PSNR values, we also calculated SSIM values, which provided another measure of the comparison of two images. All values were calculated for five slices covering the mouse neck providing the samples for the statistical analysis. Since images could be exported in formats with different precision levels between 8-bit unsigned and double precision, we calculated PSNR and SSIM values for those two extreme cases of most coarse and most precise image data. Although set 1 selected using CNM did not provide the absolute best image quality among all optimized three-wavelengths sets, it provided PSNR values within the standard deviation from the PSNR-optimized sets. We also examined larger wavelength sets obtained by clustering [24] all wavelengths found using the optimization methods. Adding one wavelength (sets 5 and 6) resulted in about 10% improvement in terms of PSNR, which was significant given that PSNR was a logarithmic measure. No further improvement was achieved using six- wavelength sets. A "standard" set of five wavelengths (set 8) recommended by iThera Medical GmbH provided images of the quality close to those obtained using the optimized three-wavelength sets 1-4. Three-wavelength sets close to a minimum of the modulus of the extinction matrix determinant provided lowest PSNRs and SSIMs and also the corresponding images were visually identified as the worst. It was notable that the wavelengths in "bad" combinations were not very close to each other and could be accidentally selected based on the idea to cover the range of wavelengths corresponding to the spectral features of the chromophores.

19

There were two sources for the distinctions between PSNR (and SSIM) values for double precision and 8-bit images: larger values for 8-bit images and larger differences between different sets for the double precision images. The first reason was the difference in the range of peak values: the standard value of 255 for the 8-bit images and the maximal pixel value of the reference image for the double-precision images. The second reason was that since 8-bit images were coarser, the overall errors were smaller. In particular, for all sets except "bad" ones (9 and 10) and almost for all slices PSNR values for QC-1 images were infinite and SSIM values were equal to one, indicating that the 8-bit QC-1 images obtained using small sets were identical to the reference images (obtained using 121 wavelengths). However, this was not the case for the Hb and HbO2 images. In the case of the double precision images all PSNR values were finite and all SSIM values were smaller than one, indicating that the double precision images obtained using small sets were not identical to the reference images. While for all sets QC-1 images showed higher PSNR and SSIM values than Hb and HbO2 images, one should note that the accurate imaging of all three chromophores was equally important for the lymphatic drainage studies because the tracer could penetrate not only the lymphatic vessels but also the blood vessels, and in addition some spectral cross-talk among all chromophores was possible. Although the optimization of SSIM values could also be used for the wavelength selection, we found that PSNR values were much more sensitive to the differences between images than SSIM values. 2.6 Conclusions Among the three-wavelengths sets, the set selected using CNM provided the average PSNR within the standard deviation from the PSNR-optimized sets. Therefore, we are confirming that CNM method [16-14] can be used if one needs to limit the number of wavelengths to the number of major chromophores. Adding one wavelength resulted in about 10% improvement in terms of PSNR, which was significant given that PSNR was a logarithmic measure. No further improvement could be achieved using six-wavelength sets. Some "arbitrary" choices of wavelengths resulted in significant image distortions. The approach that we describe here may help to improve the planning of the experiments by the selection of the minimum number of wavelengths to obtain good quality images with greater temporal resolution, which was

20

particularly helpful for the dynamic imaging of chromophores distributions required for the lymphatic drainage studies.

21

Chapter 3
Discussion, Conclusions and Future Work
3.1 Discussion Throughout our work and to assess the quality of the images, we compared images reconstructed based on different sets of wavelengths to those reconstructed based on 121 wavelengths which is the set of wavelengths between 680nm and 920nm with a 2nm step. The values of PSNR and SSIM were determined for the comparison of those images in two formats, uint8 and double precision. The reason behind the difference between the two formats, observed in the ranking of sets based on PSNR, is that PSNR is proportional to the square of the maximum fluctuation in the input image data type, which is 1 in the double image and 255 for the unsigned 8-bit one [25]. The minimum condition number algorithm was present in two sets, set 1 (680,724,930nm) which is all selected based on the algorithms and set 5 (684,728, 852, 916nm) selected through the averaging across three PSNR optimization sets and that of the minimum condition number. For the uint8 images and in terms of PSNR, set 5 showed the best results, while the worst among all sets was set 10 (726,784,884nm) which is the set selected based on the minimum PSNR for the Hb, HbO2 and QC-1 maps. Results for Set 1 (680,724,930nm) were good, close to the rest of the three other sets selected based on PSNR optimization and that was also clear in the visual comparison of images reconstructed using ViewMSOTTM software (iThera Medical GmbHversion 3.8). (Figure 5). To compare set 1 with sets of 4 wavelengths and more, a percentage difference of PSNR values was calculated for set 1 and each of other 10 sets. Set 5 shows a better result by ~8.2% (4.9dB), set 6 shows a better result by ~7.3% (4.3dB), set 7 shows a better result by ~5.7%. set 8 shows a better result by ~2.5%. Comparing PSNR for double images, set 2 and set 1 and set 2 were very close and the best for 3 wavelengths sets. The best among all sets was set 6 (5 wavelengths) and the worst was set 10. For the SSIM values, if we exclude set 10 (the worst), the percentage difference between the maximum and minimum SSIM among all sets is ~0.6% for uint8 images comparison and ~2.8% for double images comparison. This made SSIM less sensitive than PSNR comparison and thus nonbeneficial for conclusion. The approach we have developed is based on reconstructing images based on small sets of wavelengths selected based on the minimum condition number algorithm and PSNR optimization for the maps of Hb, HbO2 and QC-1 across few trial slices and then compare these maps to those reconstructed

22

based on 121 wavelengths (680-920 2nm step), and to clean the tracer map Hb and HbO2 crosstalk filters are applied.

3.2 Limitations This approach can be applied to other similar imaging studies knowing that crosstalk filters may be required but are not a necessary part except hemoglobin, because in the case of lymphatic drainage we have all three chromophores in blood vessels, but melanin or other chromophores may not be in the blood. Another issue is that the extinction matrix has to be expanded to include all chromophores and tracers and then the minimum number of wavelengths will be equal to the total number of chromophores and tracers. In terms of image quality, we used the image reconstructed using the 121 wavelengths (680nm-920nm/2nm step) to be our reference image, still this needs to be verified through the comparison of the 121-wavelength image to the real slice at exactly same position and this would be possible only through dissection. Another limitation is the related to wavelengths spectrum in which we excluded all wavelengths beyond 920nm and that was done for two main reasons, first to avoid the high absorption of water which fills the scanning chamber and second to avoid the 30% drop of the laser energy in the interval 960-980nm.

3.3 Conclusion The major target of this study is to develop a methodology to select minimum number of wavelengths to reconstruct a good quality MPAT image. To do so we applied two algorithms, the first one based on the minimum condition number algorithm introduced in [14] and the second one is based on optimized PSNR, which is a reliable quantitative image quality assessment metric. Among the three-wavelengths sets, the set selected based on the minimum condition number provided the average PSNR within the standard deviation from the PSNR-optimized sets. Therefore, we are confirming that the condition number method [14] can be used if one needs to limit the wavelength set to the number of wavelengths equal to the number of major chromophores. Adding one wavelength resulted in about 10% improvement in terms of PSNR. No further improvement could be achieved using larger wavelength sets. Some arbitrary choices of wavelength sets resulted in significant image distortions. The approach that we describe here may help to improve the planning of the experiments by the selection of the minimum number of

23

wavelengths to obtain good quality images with greater temporal resolution, which was particularly helpful for the dynamic imaging of chromophores distributions required for the lymphatic drainage studies. 3.4 Future work In some recent studies, it is shown that a variation in optical properties of mouse skin exists across gender, age, strain and pathological conditions [26]. This will be a motivation to include melanin and to scan different types of mice of higher melanin concentration in their skin. QC-1 tracer should be used in different concertation to study the sensitivity of system. In addition, different tracers should be used, and new combinations of wavelengths should be produced and analyzed same way we did in our study. Validation of chromophore concentration calculated based on our methodology with that measured using spectrometers should be performed. Another thing to be considered is the aspect of wavelength optimization from the standpoint of the optimal optical fluence evaluation within the blood or lymphatic vessels

24

Appendices

1. MATLAB® (MathWorks, Inc.) code used to determine set of three wavelengths based on the minimum condition number This code starts by importing the matrix of extinct coefficient for oxyhemoglobin , deoxyhemoglobin and QC-1 tracer. Then it starts a loop to choose all possible submatrices and calculate their corresponding condition number to choose then the set corresponding to the minimum condition number. The three corresponding wavelengths are then displayed.
m = NewSpe; minCondNum = 1e29; rowNums = [0, 0, 0, 0]; for rowNum1 = 1:373 for rowNum2 = (rowNum1+1):372 for rowNum3 = (rowNum2+1):371 for rowNum4 = (rowNum3+1):370 subMatrix = m([rowNum1, rowNum2, rowNum3,rowNum4], :); val = cond(subMatrix); if (val > minCondNum) continue; end minCondNum = val; rowNums = [rowNum1, rowNum2, rowNum3]; end end end end disp((rowNum1/numRows))

minCondNum m(rowNums, :);

2. MATLAB® (MathWorks, Inc.) code for spectral unmixing This code removes spectral spikes from PAT images by applying the 1-D median filter pixel-bypixel Then it does the spectral unmixing and exports three figures of the maps of Hb,HbO2 and QC-1 tracer. It starts by importing the 10 frames unaveraged image reconstructed using viewMSOT ver3.8 and the 1-D median filter is applied for each pixel. The code then limit the spectrum to 121 wavelengths and then it does the unmixing using the chromophores extinct coefficient matrix.
clear %Load without AV bin %% add path of required files javaaddpath('C:\Users\DAD\Documents\MSOT\MSOT_MATLAB\MSOTBeans\xbean.jar'); javaaddpath('C:\Users\DAD\Documents\MSOT\MSOT_MATLAB\MSOTBeans\msotbeans.jar' ); addpath('C:\Users\DAD\Documents\MSOT\MSOT_MATLAB\MSOTBeans\') addpath(genpath('C:\Users\DAD\Documents\MSOT\MSOT_MATLAB')); setenv('ITHERAFILES1','C:\Users\DAD\Documents\MSOT\MSOT_MATLAB\MSOTFILES'); %% set filename dirname='C:\Users\DAD\Google Drive\RU Research_\MSOT\Ihab Mar.26,2018\Scan_3\'; fname=[dirname '\Scan_3.msot']; %mkdir [dirname 'FromMatlab\'];%New folder for matlab created images

25

FileMSP=[dirname 'MSPfromMatlab'];% This will be the final MSP image file %get datainfo datainfo=loadMSOT(fname); %msp = loadMSOTMsp(datainfo,1); OriginalImage=squeeze(loadMSOTRecon(datainfo,12));%Load unaveraged image oimsize=size(OriginalImage) Rimage=zeros(oimsize(1),oimsize(2),oimsize(3)*oimsize(4)); for i=1:oimsize(3) Rimage(:,:,(i-1)*10+1:(i-1)*10+10)=OriginalImage(:,:,i,1:10); end %Demo on how the meddian filter removes spikes y=medfilt1(squeeze(Rimage(174,101,:)),15);%remove spikes. Its important that ALL frames are included in a 1-D array for i=1:oimsize(4) figure; plot(y(i:10:1500+i))%SHows filtered spectrum of the pixel hold on pause(2) plot(squeeze(Rimage(174,101,i:10:1500+i)))%C filtered spectrum of the pixel pause(2) close end %Removing spikes imsize=size(Rimage); NewImage=zeros(imsize); %Create an array of zeros for the new image of the same size and dimensions as the original image for n=1:imsize(1) for m=1:imsize(2) NewImage(m,n,:)= medfilt1(squeeze(Rimage(m,n,:)),15);%remove spikes pix by pix end end %NewImage=Rimage; %Average frames clear R Q R=NewImage(:,:,1:10:1501); for i=2:10 R=R+squeeze(NewImage(:,:,i:10:1500+i)); end R=R/10; % imwrite(uint8(R(:,:,1)),'nospike_680-980-2nm-10 frames-without AV.tiff') % for i=2:NumberWavelengths % imwrite(uint8(R(:,:,i)),'nospike_680-980-2nm-10 frames-without AV.tiff','WriteMode','append') % end %NumberWavelengths=151; %MSP processing Wavelength =[680:2:980]'; %R(:,:,:,:,:,126:end)=[]; %Q=R(:,:,:,:,:,1:20:101); Q=R(:,:,1:121)/max(max(max(R)));%limit wavelengths to avoid water %MSP = loadMSOTMsp(datainfo,1); %Create a mask %W1=mean(squeeze(R(:,:,:,:,:,65:85)),3); W1=mean(squeeze(R(:,:,26:30)),3); figure; imagesc(W1) BW = imbinarize(W1/max(max(max(R)))*5, .2); BW2=bwareafilt(BW,5); figure; imagesc(BW2); %wv=Wavelength(1:end,1); wv1=Wavelength(1:121,1); %wv1=wv; % load tr; % load C:\Users\DAD\Documents\MATLAB\Package\speu load('MSOT_SPECTRA.mat'); %spect=interp1(spe(:,1),spe(:,2:8),wv1); spect=interp1(spe(:,1),spe,wv1); % spect(:,6:7)=[]; % spect(:,4)=[]; %SPEC=spect(:,2:4); eox=spect(:,3); edx=spect(:,2); ewr=spect(:,4); eft=spect(:,5); etr=spect(:,6)*40000;

26

%etr=interp1(iw,itr,wv1)*100; SPEC=[eox edx etr]; options=optimoptions('lsqcurvefit','Display','off','maxiter',5000,'maxfuneval s',150000,'TolFun',1e-10,'UseParallel',true);% %GAS=[.2 0 0 2 10 200 200 0]; fPSI=@(C,wv)PSI(C,wv,eox,edx,ewr,eft,etr); OXY=zeros(size(W1)); DXY=zeros(size(W1)); WAT=zeros(size(W1)); FAT=zeros(size(W1)); TRA=zeros(size(W1)); sz1=oimsize(1); sz2=oimsize(2); %MSP using lsqurvefit or linear regression tic parfor i=1:sz1 for j=1:sz2 if BW2(i,j)==1 yy=squeeze(Q(i,j,:));%spectrum of the current pixel %[GAS,resnorm] = lsqcurvefit(fPSI,[.1 .1 .1 .1 10 10 10 .1],wv1,yy,[0 0 0 0 0 0 0 0],[10 10 10 10 10 10 10 10],options);%non-linear fit %[GAS,resnorm] = lsqcurvefit(fPSI,[.2 0 0],wv1,yy,[.000 0.000 0.000],[.4 .15 5],options);%non-linear fit GAS=regress(yy, SPEC); OXY(i,j)=GAS(1); DXY(i,j)=GAS(2); % WAT(i,j)=GAS(3); % FAT(i,j)=GAS(4); % TRA(i,j)=GAS(8); TRA(i,j)=GAS(3); end end end toc OXY=OXY*0.5e5; DXY=DXY*0.5e5; TRA=TRA*0.5e5; OXY(find(OXY<0))=0; DXY(find(DXY<0))=0; TRA(find(TRA<0))=0; BW3 = imbinarize(TRA/max(max(TRA)), .1);TRA=(TRA.*BW3); BW4 = imbinarize(OXY/max(max(OXY)), .3);OXY=(OXY.*BW4); BW5 = imbinarize(DXY/max(max(DXY)), .3);DXY=(DXY.*BW5); figure; imagesc(OXY);colorbar figure; imagesc(DXY);colorbar figure; imagesc(TRA);colorbar msp = squeeze(loadMSOTMsp(datainfo,1)); msp(find(msp<0))=0; msp(:,:,1)=msp(:,:,1).*BW5; msp(:,:,2)=msp(:,:,2).*BW3; msp(:,:,3)=msp(:,:,3).*BW4; %figure; imagesc((100*msp(:,:,1,1,1,3)./max(max(msp(:,:,1,1,1,3)))100*OXY./max(max(OXY))));colorbar MSE = sum(sum((msp(:,:,3)./max(max(msp(:,:,3)))OXY./max(max(OXY))).^2))/(sz1*sz2); PSNR = 10*log10(255*255/MSE) %figure; imagesc((100*msp(:,:,1,1,1,1)./max(max(msp(:,:,1,1,1,1)))100*DXY./max(max(DXY))));colorbar MSE = sum(sum((msp(:,:,1)./max(max(msp(:,:,1)))DXY./max(max(DXY))).^2))/(sz1*sz2); PSNR = 10*log10(255*255/MSE) %figure; imagesc((100*msp(:,:,1,1,1,2)./max(max(msp(:,:,1,1,1,2))100*TRA./max(max(TRA)))));colorbar MSE = sum(sum((msp(:,:,2)./max(max(msp(:,:,2)))TRA./max(max(TRA))).^2))/(sz1*sz2); PSNR = 10*log10(255*255/MSE) %Create MSP data %MSP=squeeze(msp(:,:,1,1,1,:)); clear MSP MSP(:,:,1)=OXY; MSP(:,:,2)=TRA; MSP(:,:,3)=DXY; MSP=255*MSP/max(max(max(MSP))); MSP=uint8(MSP); alpha = 255*ones([sz1 sz2], 'uint8'); data = cat(3,MSP,alpha);

27

%Save MSP %Create a Tiff object. t = Tiff([FileMSP '.tiff'],'w'); %Set the Tiff tags and specify the value of the ExtraSamples tag because the data contains the alpha channel in addition to the color channels. setTag(t,'Photometric',Tiff.Photometric.RGB); setTag(t,'Compression',Tiff.Compression.None); setTag(t,'BitsPerSample',8); setTag(t,'SamplesPerPixel',4); setTag(t,'SampleFormat',Tiff.SampleFormat.UInt); setTag(t,'ExtraSamples',Tiff.ExtraSamples.Unspecified); setTag(t,'ImageLength',sz1); setTag(t,'ImageWidth',sz2); setTag(t,'TileLength',32); setTag(t,'TileWidth',32); setTag(t,'PlanarConfiguration',Tiff.PlanarConfiguration.Chunky); %Write the data to the TIFF file and close the Tiff object. write(t,data); close(t); save([FileMSP '.mat'],'Wavelength','OXY','DXY','TRA','R','W1','msp')

3. MATLAB® (MathWorks, Inc.) code for PSNR and SSIM calculation In this code, first the long format is chosen to increase sensitivity of the calculated PSNR and SSIM. First the images to be compared are imported and then using two formats of the psnr and ssim commands (uint8-usigend 8-bit image and double image) the code export the values in `.xls' format.
format long; I=getimage; close J=getimage; P1=psnr(uint8(I),uint8(J)); S1=ssim(uint8(I),uint8(J)); P2=psnr(I,J,max(max(I))); S2=ssim(I,J); A=[P1,S1,P2,S2]; disp(A) xlswrite('Book1',A);

28

Reference
[1] Tham, Y. C., Li, X., Wong, T. Y., Quigley, H. A., Aung, T., & Cheng, C. Y. (2014). Global prevalence of glaucoma and projections of glaucoma burden through 2040: a systematic review and metaanalysis. Ophthalmology, 121(11), 2081-2090. [2] Yücel, Y. H., Cardinell, K., Khattak, S., Zhou, X., Lapinski, M., Cheng, F., & Gupta, N. (2018). Active Lymphatic Drainage From the Eye Measured by Noninvasive Photoacoustic Imaging of NearInfrared Nanoparticles. Investigative ophthalmology & visual science, 59(7), 2699-2707. [3] Xu, M., & Wang, L. V. (2006). Photoacoustic imaging in biomedicine. Review of scientific instruments, 77(4), 041101. [4] Xiao, J., Yuan, Z., He, J., & Jiang, H. (2010). Quantitative multispectral photoacoustic tomography and wavelength optimization. Journal of X-ray science and technology, 18(4), 415-427. [5] Taruttis, A., & Ntziachristos, V. (2015). Advances in real-time multispectral optoacoustic imaging and its applications. Nature Photonics, 9(4), 219. [6] Upputuri, P. K., & Pramanik, M. (2016). Recent advances toward preclinical and clinical translation of photoacoustic tomography: a review. Journal of Biomedical Optics, 22(4), 041006 [7] Ntziachristos, V., & Razansky, D. (2010). Molecular imaging by means of multispectral optoacoustic tomography (MSOT). Chemical reviews, 110(5), 2783-2794. [8] Deán-Ben, X. L., Gottschalk, S., Mc Larney, B., Shoham, S., & Razansky, D. (2017). Advanced optoacoustic methods for multiscale imaging of in vivo dynamics. Chemical Society Reviews, 46(8), 2158-2198. [9] Salehi, H. S., Li, H., Kumavor, P. D., Merkulov, A., Sanders, M., Brewer, M., & Zhu, Q. (2015, March). Wavelength optimization for in vivo multispectral photoacoustic/ultrasound tomography of hemoglobin oxygenation in ovarian cancer: clinical studies. In Photons Plus Ultrasound: Imaging and Sensing 2015 (Vol. 9323, p. 932303). International Society for Optics and Photonics. [10] Luke, G. P., Myers, J. N., Emelianov, S. Y., & Sokolov, K. V. (2014). Sentinel lymph node biopsy revisited: ultrasound-guided photoacoustic detection of micro metastases using molecularly targeted plasmonic Nano sensors. Cancer research [11] Jarvi, M. T., Patterson, M. S., & Wilson, B. C. (2012). Insights into photodynamic therapy dosimetry: simultaneous singlet oxygen luminescence and photosensitizer photobleaching measurements. Biophysical journal, 102(3), 661-671. [12] iThera Medical GmbH. (2016). inVesion128: User guide [13] Xiao, J., Yuan, Z., He, J., & Jiang, H. (2010). Quantitative multispectral photoacoustic tomography and wavelength optimization. Journal of X-ray science and technology, 18(4), 415-427. [14] Luke, G. P., & Emelianov, S. Y. (2014). Optimization of in vivo spectroscopic photoacoustic imaging by smart optical wavelength selection. Optics letters, 39(7), 2214-2217. [15] Tzoumas, S., & Ntziachristos, V. (2017). Spectral unmixing techniques for optoacoustic imaging of tissue pathophysiology. Phil. Trans. R. Soc. A, 375(2107), 20170262. [16] Yuan, Z., & Jiang, H. (2009). Simultaneous recovery of tissue physiological and acoustic properties and the criteria for wavelength selection in multispectral photoacoustic tomography. Optics Letters, 34(11), 1714-1716. [17] Perekatova, V., Subochev, P., Kleshnin, M., & Turchin, I. (2016). Optimal wavelengths for optoacoustic measurements of blood oxygen saturation in biological tissues. Biomedical optics express, 7(10), 3979-3995. [18] Larobina, M., & Murino, L. (2014). Medical image file formats. Journal of digital imaging, 27(2), 200-206.

29

[19] Sandberg, K. (2007). Introduction to image processing in Matlab. Department of Applied Mathematics, University of Colorado at Boulder, http://amath. colorado. edu/courses/4720/2000Spr/Labs/Worksheets/Matlab_tutorial/matlabimpr. [20] Wang, Z., Bovik, A. C., Sheikh, H. R., & Simoncelli, E. P. (2004). Image quality assessment: from error visibility to structural similarity. IEEE transactions on image processing, 13(4), 600-612. [21] Zhang, H. F., Maslov, K., Stoica, G., & Wang, L. V. (2006). Functional photoacoustic microscopy for high-resolution and noninvasive in vivo imaging. Nature Biotechnology, 24(7), 848. [22] Moore Jr, J.E. and Bertram, C.D., 2018. Lymphatic system flows. Annual review of fluid mechanics, 50, pp.459-482. [23] Corlu, A., Durduran, T., Choe, R., Schweiger, M., Hillman, E.M., Arridge, S.R. and Yodh, A.G., 2003. Uniqueness and wavelength optimization in continuous-wave multispectral diffuse optical tomography. Optics Letters, 28(23), 2339-2341. [24] Seber, G. A. F. Multivariate Observations. Hoboken, NJ: John Wiley & Sons, Inc., 1984 [25] Hemanth, D. J., & Smys, S. (Eds.). (2018). Computational Vision and Bio Inspired Computing (Vol. 28). Springer. [26] Sabino, C. P., Deana, A. M., Yoshimura, T. M., da Silva, D. F., França, C. M., Hamblin, M. R., & Ribeiro, M. S. (2016). The optical properties of mouse skin in the visible and near infrared spectral regions. Journal of Photochemistry and Photobiology B: Biology, 160, 72-7

30


